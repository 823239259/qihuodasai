<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<title>提现</title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<link href="../../css/mui.min.css" rel="stylesheet" />
		<link href="../../css/common.css" rel="stylesheet" />
		<link href="../../css/account.css" rel="stylesheet" />
	</head>
	<body class="withdrawals">
		<header class="mui-bar mui-bar-nav">
			<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
			<h1 class="mui-title">提现</h1>
			<a class="mui-pull-right header-right-button" id="WithdrawalsList">提款记录</a>
		</header>
		<div class="mui-content">
			<p class="top-tips">账户余额</p>
			<p class="account-balance" id="accountBalance">0.00</p>
			<ul class="mui-table-view mui-table-view-chevron withdrawals-information-list">
				<li class="mui-table-view-cell">
					<label>提现金额</label>
					<input type="number" placeholder="请输入金额，需大于10" id="WithdrawalsMoney" onkeyup="this.value=this.value.replace(/\D/g,'')" onafterpaste="this.value=this.value.replace(/\D/g,'')" />
					<label>元</label>
				</li>
				<li class="mui-table-view-cell">
					<a class="mui-navigate-right" href="javascript:void(0)">
						<label>提现银行卡</label>
						<span>
							<select id="backList">
							</select>
							<span id="abbreviation" style="display: none;"></span>
						</span>
					</a>
				</li>
				<li class="mui-table-view-cell">
					<!--<a class="mui-navigate-right" href="">-->
					<label>实际到账</label>
					<span id="draw_time">0.00</span>
					<!--</a>-->
				</li>
			</ul>
			<p class="counter-fee">扣除手续费：<em id="drawHandleFee">0.00 </em>元</p>
			<ul class="mui-table-view mui-table-view-chevron withdrawals-information-list">
				<li class="mui-table-view-cell">
					<label>提现密码</label>
					<input id="drawpassword" type="password" class="mui-input-password" placeholder="请输入提现密码" autocomplete="off" onkeyup="value=value.replace(/[\W]/g,'')" onbeforepaste="clipboardData.setData('text',clipboardData.getData('text').replace(/[^\d]/g,''))">
				</li>
			</ul>
			<p class="counter-fee" style="height: 40px; line-height: 40px;"><a id="modifyPassword" style="color: #fc3;">设置/修改提现密码</a></p>
			<p class="buttom-button">
				<button id="confirmButton">确 认</button>
			</p>
			<div class="reminder">
				<p>温馨提示：</p>
				<p>1.到账时间：工作日09:00-16:30申请，24小时内到账，最快5分钟到账，其余时间申请将在下个工作日到账；</p>
				<p>2.提现手续费：（a）1%（适用于充值后，未实际操盘金额）。（b）0元（适用于操盘用户提现）。</p>
			</div>
			
			<div class="mui-backdrop chioce">
				<div class="settting-password">
					<p class="backdrop-title">输入兑换密码<span class="mui-icon mui-icon-closeempty mui-pull-right cancel" data-id="password" id="cancel"></span></p>
					<p>提现到尾号<em id="cardInfomation">0719</em>的银行卡</p>
					<div class="ipt-box-nick">
			        	<div style="width: 100%; height: 50px; position: relative; overflow: hidden; z-index: 3;"><input type="text" maxlength="6"  class="ipt-real-nick"/></div>
				        <div class="ipts-box-nick">
				            <div class="ipt-fake-box">
				                <input type="password" style="border-top-left-radius: 5px; border-bottom-left-radius: 5px;">
				                <input type="password" >
				                <input type="password" >
				                <input type="password" >
				                <input type="password" >
				                <input type="password" style="border-top-right-radius: 5px; border-bottom-right-radius: 5px;">
				            </div>
				        </div>
			    	</div>
					<p id="forgetPassword">忘记密码?</p>
				</div> 
			</div>
		</div>
	</body>
	<script type="text/javascript" src="../../js/mui.min.js"></script>
	<script type="text/javascript" src="../../js/common.js"></script>
	<script type="text/javascript" src="../../js/jquery-1.11.3.js"></script>
	<script>
		var SetDrawPwd=null;
		var dataBankList=null;
		mui.app_request('/user/getbalancerate', {
			"businessType": 4
		}, function(result) {
//			console.log(JSON.stringify(result));
			if(result.success == true) {
				insertAccountData(result.data)
			}
		}, function(res) {});
		mui.app_request('user/withdraw/bank_list', {}, function(result) {
//			console.log(JSON.stringify(result));
			if(result.success == true) {
				dataBankList=result.data;
				insertBankData(result.data)
			}
		}, function(res) {});

		function insertAccountData(data) {
			var accountBalance = document.getElementById("accountBalance");
			if(!mui.isnull(data.balance)) {
				accountBalance.innerText = data.balance;
			} else {
				accountBalance.innerText = "0.00";
			}
			SetDrawPwd= data.isSetDrawPwd;
		}
		document.getElementById("confirmButton").addEventListener("tap", function() {
			confirmData();
		});
		document.getElementById("forgetPassword").addEventListener("tap", function() {
			mui.open_window_data(
				"withdramalsPassword.html", "withdramalsPassword",{ 
					"backpageID": "Withdrawals","url": "Withdrawals.html" 
				}
			);
		});
		document.getElementById("WithdrawalsList").addEventListener("tap", function() {
			mui.openWindow({ "url": "presentationRecord.html", "id": "presentationRecord" });
		});
		document.getElementById("WithdrawalsMoney").addEventListener("input", function() {
			Withdrawals()
			drawMoney();
		});
		document.getElementById("modifyPassword").addEventListener("tap",function(){
			mui.open_window_data("withdramalsPassword.html", "withdramalsPassword", { "backpageID": "Withdrawals", "url": "Withdrawals.html" });
		});
		function Withdrawals() {
			var WithdrawalsMoney = document.getElementById("WithdrawalsMoney").value;
			if(Number(WithdrawalsMoney) < 10) {
				mui.toast("提现金额必须大于10元起");
				return
			}
		}

		function insertBankData(data) {
//			console.log(JSON.stringify(data));
			for(var i = 0; i < data.length; i++) {
				if(data[i].default) {
					$("#backList").append("<option data-abbreviation='"+data[i].abbreviation+"' selected='selected' value='" + data[i].card + "'>" + data[i].bankName + " " + data[i].card + "</option>");
					$("#abbreviation").html(data[i].abbreviation);
				} else {
					$("#backList").append("<option data-abbreviation='"+data[i].abbreviation+"' value='" + data[i].card + "'>" + data[i].bankName + " " + data[i].card + "</option>");
				}
			}
		}

		function drawMoney() {
			var WithdrawalsMoney = document.getElementById("WithdrawalsMoney").value;
			if(mui.isnull(WithdrawalsMoney)) {
				document.getElementById("WithdrawalsMoney").value = "";
				mui.toast("不能输入非法字符");
				return;
			}
			if(WithdrawalsMoney > parseFloat($("#accountBalance").text())) {
				mui.toast("账户余额不足");
				return;
			}
			mui.app_request("user/withdraw/drawFee", {
				"money": WithdrawalsMoney
			}, function(result) {
//				console.log(JSON.stringify(result));
				var message = result.data.fee;
				$("#drawHandleFee").text(message);
				if(!isNaN(message)) {
					$("#draw_time").text(WithdrawalsMoney - message);
				}
				return;
			}, function(result) {
				return;
			})

		};
		//确认提现
		function confirmData(){
			if(SetDrawPwd ==false){
				mui.openWindow()
			}
			var card=$("#backList").val();
			if(card ==null && card ==""){
				mui.toast("请选择银行卡");
				return
			}
			var WithdrawalsMoney = $("#WithdrawalsMoney").val();
			if(!WithdrawalsMoney){
				mui.toast("请输入提现金额");
				return
			}
			if(WithdrawalsMoney < 11){
				mui.toast("输入金额需大于10元");
				return
			}
			var WithdrawalsMoney = document.getElementById("WithdrawalsMoney").value;
			if(WithdrawalsMoney > parseFloat($("#accountBalance").text())) {
				mui.toast("账户余额不足");
				return;
			}
			var drawpassword=document.getElementById("drawpassword").value;
			mui.app_request("/user/getbalancerate",{"businessType": 4},function(result){
				if(result.data.isSetDrawPwd){
					passworld(drawpassword);
				}else {
					var btnArray = ['否', '是'];
					mui.confirm('您当前还未设置提现密码，请先设置提现密码！', '提示', btnArray, function(e) {
						if (e.index == 1) {
							mui.open_window_data("withdramalsPassword.html", "withdramalsPassword", { "backpageID": "Withdrawals", "url": "Withdrawals.html" });
						}
					});
				}
			});
			if(mui.isnull(drawpassword)){
				mui.toast("请输入提现密码");
				return;
			}
			
		}
		/*输入提现密码*/
		$(".ipt-real-nick").focus(function(){
			$(".ipt-box-nick .ipt-real-nick").css("right","1000px");
		}).blur(function () {  
			$(".ipt-box-nick .ipt-real-nick").css("right","0");
		});
		
		$(".ipt-real-nick").on("input", function() {	
			var $input = $(".ipt-fake-box input");
			if(/^[0-9]*$/g.test($(this).val())){
				var pwd = $(this).val().trim();
				for (var i = 0, len = pwd.length; i < len; i++) {
					$input.eq(i).val(pwd[i]);
				}
				$input.each(function() {
				    var index = $(this).index();
				    if (index >= len) {
				        $(this).val("");
				    }
				});
				if (len == 6) {
				    passworld($(this).val());
				}
			}else{
			    var arr=$(this).val().match(/\d/g);
			    $(this).val($(this).val().slice(0,$(this).val().lastIndexOf(arr[arr.length-1])+1));
			}
    	});
    	/*提现密码输入完成时*/ 
		function passworld(password) {
			var bank = $("#backList option:selected").attr("data-abbreviation");
			var abbreviation = $("#backList option:selected").val();
			var WithdrawalsMoney = $("#WithdrawalsMoney").val();
			mui.app_request("/user/withdraw/handle",{
				"bank":bank,
				"card": abbreviation,
				"money": WithdrawalsMoney,
				"withdrawPwd": password
			},function(result){
		  		if(result.success == true) {
		  			$(".mui-backdrop").addClass("chioce");
		  			mui.toast("提现成功");
		  			mui.open_window_data("presentationRecord.html", "presentationRecord", { "backpageID": "Withdrawals", "url": "Withdrawals.html" });
			  	}
		  	},function(result){
		  		console.log(JSON.stringify(result));
	  			if(result.code==3){
			  		mui.toast("用户信息不存在");
			  		return;
			  	}else if(result.code==4){
			  		mui.toast("银行卡卡号不存在");
			  		return;
			  	}else if(result.code==5){
			  		mui.toast("存在欠费无法提现");
			  		return;
			  	}else if(result.code==6){
			  		mui.toast("系统升级期间无法提现");
			  		return;
			  	}else if(result.code==7){
			  		mui.toast("余额不足不能提现");
			  		return;
			  	}else if(result.code==8){
			  		mui.toast("当天取款次数不能超过5次");
			  		return;
			  	}else if(result.code==9){
			  		mui.toast("每次提现金额不能小于10元");
			  		return;
			  	}else if(result.code==10){
			  		mui.toast("提现密码错误");
			  		return;
			  	}else if(result.code==11){
			  		mui.toast("网银平台暂不支持此银行提现，请添加其他银行！");
			  		return;
			  	}else if(result.code==12){
			  		mui.toast("网银限制，单笔提现金额不能超过50000元，每天可提现5笔（币币支付）。");
			  		return;
			  	}else if(result.code==13){
			  		mui.toast("未实名认证");
			  		return;
			  	}else if (result.code==14){
			  		mui.toast("网银限制，单笔提现金额不能超过500000元，每天可提现5笔（易支付支付）。");
			  		return;
			  	}
			});
		}
		document.getElementById("cancel").addEventListener("tap", function() {
			$(".mui-backdrop").addClass("chioce");
		});
	    $("#backList").change(function(){
	    	var value=$("#backList").val();
	    	console.log(value);
	    	$("#cardInfomation").html(value.substring(value.length-4,value.length));
	    	for(var i=0;i<dataBankList.length;i++){
	    		if(value==dataBankList[i].card){
	    			$("#abbreviation").html(dataBankList[i].abbreviation);
	    			return;
	    		}
	    	}
	    })
	</script>

</html>