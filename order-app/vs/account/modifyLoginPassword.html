<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<title>修改登录密码</title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<link href="../../css/mui.min.css" rel="stylesheet" />
		<link href="../../css/common.css" rel="stylesheet"/>
		<link href="../../css/account.css"  rel="stylesheet"/>
	</head>
	<body>
		<header class="mui-bar mui-bar-nav">
		    <a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
		    <h1 class="mui-title">修改登录密码</h1>
		</header>
		<div class="mui-content">
			<ul class="mui-table-view password-withdramals">
				<li class="mui-table-view-cell">
					<label>原号码</label>
					<input type="number" placeholder="请输入原号码" id="phone" />
					<button id="code">获取验证码</button>
				</li>
				<li class="mui-table-view-cell">
					<label>验证码</label>
					<input type="number" placeholder="输入验证码" id="oldCode" />
				</li>
			</ul>
			<div class="passwore-row-contanier">
				<div class="passwore-row new-passsword-row">
					<label>新密码</label>
					<input type="password" placeholder="请输入新密码" id="newPassword" onkeyup="value=value.replace(/[^\w\.\/]/ig,'')"/>
				</div>
				<div class="passwore-row">
					<label>确认密码</label>
					<input type="password" placeholder="请再次输入新密码" id="confirmPassword" onkeyup="value=value.replace(/[^\w\.\/]/ig,'')"/>
				</div>
			</div>
			<div class="bottom-button-contanier">
				<button id="confirmPasswordButton">确 认</button>
				<p>如遇到问题，请拨打<em id="telBtn"> 400-852-8008</em></p>
			</div>
		</div>
		<script type="text/javascript" src="../../js/mui.min.js"></script>
		<script type="text/javascript" src="../../js/common.js"></script>
		<script type="text/javascript" src="../../js/jquery-1.11.3.js"></script>
		<script>
			mui.init();
			vs.callService();
			document.getElementById("code").addEventListener("tap",function(){
				var phone = document.getElementById("phone").value;
				if(phone == "" || phone == null){
					mui.toast("请输入手机号码");
					return
				}
				if(!vs.validate_mobile(phone)){
					mui.toast("手机号码不正确");
					return;
				}
				mui.app_request('sms',{ 
      			 'mobile':phone,
			    'type':2   
	      		},function(result){
	      				mui.toast("发送成功！"); 
	      				var o=document.getElementById("code");
			  			vs.smsTime(o); 
	      				return;
	      				
	      		},function(result){
	      			console.log(result);
	      			if(result.code==2){
	      				mui.toast("短信验证码发送失败！");
	      				return;
	      			}else if(result.code==5){
	      				mui.toast("操作过于频繁，请稍后再试！");
	      				return;
	      			}else if(result.code==4){
	      				mui.toast("手机号码不存在！");
	      				return;
	      			}else{
	      				mui.toast("系统繁忙，请稍后再试！");
	      				return;
	      			}
	      		});
			})
			document.getElementById("confirmPasswordButton").addEventListener("tap",function(){
				var phone = document.getElementById("phone").value;
				var oldCode = document.getElementById("oldCode").value;
				var newPassword = document.getElementById("newPassword").value;
				var confirmPassword = document.getElementById("confirmPassword").value;
				if(phone == "" || phone == null){
					mui.toast("请输入手机号码");
					return
				}
					if(oldCode == "" || oldCode == null){
					mui.toast("请输入验证码");
					return
				}
				if(newPassword == "" || newPassword == null){
					mui.toast("请输入新密码");
					return
				}
				if(confirmPassword == "" || confirmPassword == null){
					mui.toast("请再次输入新密码");
					return
				}
				if(confirmPassword != newPassword){
					mui.toast("两次输入不一致");
					return
				}
				if(!vs.validate_password(newPassword)){
					mui.toast("密码由6-16位数字和字母组成。");
					return;
				}
				modifLoginPassword(newPassword);
			});
			function modifLoginPassword(newPassword){
				var phone = document.getElementById("phone").value;
				var oldCode = document.getElementById("oldCode").value;
				console.log(oldCode);
				mui.app_request('/reset_password',{ 
      			 'mobile':phone,
      			 'code':oldCode,
			    'password':newPassword
      		},function(result){
      			console.log(JSON.stringify(result));
      				mui.toast("密码重置成功，请重新登录！");
      				mui.cacheUser.clear();
			  		mui.openWindow("../login/login.html",'login');
      				return;
      		},function(result){
      			console.log(JSON.stringify(result));
      			if(result.code==2){
      				mui.toast("重置失败！");
      				return;
      			}else if(result.code==6){
      				mui.toast("密码格式有误！");
      				return;
      			}else if(result.code==5){
      				mui.toast("验证码错误或为空！");
      				return;
      			}else if(result.code==4){
      				mui.toast("验证码失效！");
      				return;
      			}else if(result.code==3){
      				mui.toast("用户信息不存在！");
      				return;
      			}else{
      				mui.toast("系统繁忙，请稍后再试！");
      				return;
      			}
      			
      		});
			}
		</script>
	</body>
</html>
