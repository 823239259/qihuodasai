<!doctype html>
<html>

	<head>
		<meta charset="UTF-8">
		<title></title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<link href="../css/mui.min.css" rel="stylesheet" />
		<link rel="stylesheet" href="../css/yhqh.css" />
		<link rel="stylesheet" href="../css/own.css" />
		<script src="../js/mui.min.js"></script>
		<script src="../js/common.js"></script>
		<script src="../js/mui.js"></script>
		<script src="../js/common.config.js"></script>
		<script src="../js/jquery-1.11.3.js"></script>
		
		<script type="text/javascript" src="../../../js/common.config.js"></script>
		<link href="../css/quotation.css" rel="stylesheet" />
	</head>
	<body>
		<!--头部-->
		<header class="mui-bar mui-bar-nav myHeader_color">
			<h1 class="mui-title myTitle_color">行情中心</h1>
		</header>
		<!--菜单-->
		<nav class="navlist">
			<a href="javascript:void(0);" id="toHome">
				<span class="mui-icon"><img  class="mymenu-icon" id="mymenu-icon" src="../images/home_02.png"/></span>
				<span class="mui-tab-label">首页</span>
			</a>
			<a class="yh_active" href="javascript:void(0);" id="toHangqing">
				<span class="mui-icon"><img class="mymenu-icon" src="../images/hq_01.png"/></span>
				<span class="mui-tab-label" style="color: black;">行情</span>
			</a>
			<a class="" href="javascript:void(0);" id="tozixun">
				<span class="mui-icon"><img class="mymenu-icon" src="../images/zixun_02.png"/></span>
				<span class="mui-tab-label">资讯</span>
			</a>
		</nav>
		<div class="mui-content">
			<div class="mui-content own-mainlist">
			<div class="mui-slider" id="slider">
				
				<div id="fisrtLlist"><span style="width: 15%;">行情</span><span style="width: 23%;">合约名称</span><span>最新价</span><span>成交量</span><span>涨跌幅</span></div>
			</div>
			<!--<div id="netWorkTips">当前行情网络未连接，会自动连接！</div>-->
			<div class="productList">
				<div class='openPage'>
					<div class="productTitle">
						-
					</div>
					<div class="productContentLeft">
						<p class="productName">-</p>
						<p class="grayFont CommodityNo">-</p>
					</div>
					<div class="productContentRight">
						<span class=" QLastPrice">-</span>
					 	<span class="LastVolume">-</span>
						<span><p class=" ChangeRate">-</p></span>
					</div>
				</div>
				<div class='openPage'>
					<div class="productTitle">
						-
					</div>
					<div class="productContentLeft">
						<p class="productName">-</p>
						<p class="grayFont CommodityNo">-</p>
					</div>
					<div class="productContentRight">
						<span class=" QLastPrice">-</span>
					 	<span class="LastVolume">-</span>
						<span><p class=" ChangeRate">-</p></span>
					</div>
				</div>
				<div class='openPage'>
					<div class="productTitle">
						-
					</div>
					<div class="productContentLeft">
						<p class="productName">-</p>
						<p class="grayFont CommodityNo">-</p>
					</div>
					<div class="productContentRight">
						<span class=" QLastPrice">-</span>
					 	<span class="LastVolume">-</span>
						<span><p class=" ChangeRate">-</p></span>
					</div>
				</div>
				<div class='openPage'>
					<div class="productTitle">
						-
					</div>
					<div class="productContentLeft">
						<p class="productName">-</p>
						<p class="grayFont CommodityNo">-</p>
					</div>
					<div class="productContentRight">
						<span class=" QLastPrice">-</span>
					 	<span class="LastVolume">-</span>
						<span><p class=" ChangeRate">-</p></span>
					</div>
				</div>
				<div class='openPage'>
					<div class="productTitle">
						-
					</div>
					<div class="productContentLeft">
						<p class="productName">-</p>
						<p class="grayFont CommodityNo">-</p>
					</div>
					<div class="productContentRight">
						<span class=" QLastPrice">-</span>
					 	<span class="LastVolume">-</span>
						<span><p class=" ChangeRate">-</p></span>
					</div>
				</div>
				<div class='openPage'>
					<div class="productTitle">
						-
					</div>
					<div class="productContentLeft">
						<p class="productName">-</p>
						<p class="grayFont CommodityNo">-</p>
					</div>
					<div class="productContentRight">
						<span class=" QLastPrice">-</span>
					 	<span class="LastVolume">-</span>
						<span><p class=" ChangeRate">-</p></span>
					</div>
				</div>
				<div class='openPage'>
					<div class="productTitle">
						-
					</div>
					<div class="productContentLeft">
						<p class="productName">-</p>
						<p class="grayFont CommodityNo">-</p>
					</div>
					<div class="productContentRight">
						<span class=" QLastPrice">-</span>
					 	<span class="LastVolume">-</span>
						<span><p class=" ChangeRate">-</p></span>
					</div>
				</div>
				<div class='openPage'>
					<div class="productTitle">
						-
					</div>
					<div class="productContentLeft">
						<p class="productName">-</p>
						<p class="grayFont CommodityNo">-</p>
					</div>
					<div class="productContentRight">
						<span class=" QLastPrice">-</span>
					 	<span class="LastVolume">-</span>
						<span><p class=" ChangeRate">-</p></span>
					</div>
				</div>
				<div class='openPage'>
					<div class="productTitle">
						-
					</div>
					<div class="productContentLeft">
						<p class="productName">-</p>
						<p class="grayFont CommodityNo">-</p>
					</div>
					<div class="productContentRight">
						<span class=" QLastPrice">-</span>
					 	<span class="LastVolume">-</span>
						<span><p class=" ChangeRate">-</p></span>
					</div>
				</div>
				<div class='openPage'>
					<div class="productTitle">
						-
					</div>
					<div class="productContentLeft">
						<p class="productName">-</p>
						<p class="grayFont CommodityNo">-</p>
					</div>
					<div class="productContentRight">
						<span class=" QLastPrice">-</span>
					 	<span class="LastVolume">-</span>
						<span><p class=" ChangeRate">-</p></span>
					</div>
				</div>
			</div>
		</div>
		</div>

	</body>
	<script type="text/javascript">
		mui.plusReady(function() {
			var sliderHeight = $("#slider").outerHeight();
			$(".productList").css({
		        "padding-top":sliderHeight+"px",
		    });
			tzdr.init.initHearListener();
			var dataUrl = {
				home: "../home.html",
				hangqing: "hangqing.html",
				zixun:"zixun.html"
			};
			initBottom(dataUrl);
			var url = marketSocketUrl;
			var socket=null;
			//设置变量
			var CommodityName=[];
			var CommodityNo1=[];
			var CommodityNo2=[];
			var DotSize=[];
			var ExchangeNo=[];
			var MiniTikeSize=[];
			var ContractSize = [];
			var product={
			    CommodityName:CommodityName,
			    CommodityNo1:CommodityNo1,
			    CommodityNo2:CommodityNo2,
			    DotSize:DotSize,
			    ExchangeNo:ExchangeNo,
			    MiniTikeSize:MiniTikeSize,
			    ContractSize:ContractSize
			}
			function sendMessage(method,parameters){
			    socket.send('{"Method":"'+method+'","Parameters":'+parameters+'}');
			}
			initmarketSocket();
			function initmarketSocket(){
				socket = new WebSocket(url);
				if(socket==null){
					return
				}
				socket.onopen = function(evt){
				    var user = marketUserName;
				    var pwd = marketPassword;
				    socket.send('{"Method":"Login","Parameters":{"UserName":"' + user +'","PassWord":"' + pwd +'"}}');
				    $("#netWorkTips").css("display","none");
				    mui.toast("行情服务器连接成功！");
				    $(".mui-bar").css("background-color","#ffffff");
				};
				socket.onclose = function(evt){
				};
				socket.onmessage = function(evt){ 
				    var data = evt.data;
				    var jsonData = JSON.parse(data);
				    var method = jsonData.Method;
				    if(method=="OnRspLogin"){
				    	  sendMessage('QryCommodity',null)
				    }else if(method == "OnRspQryCommodity"){
				        sendSubscrib(jsonData);
				        //插入主力合约
				        AddTo();
				        $(".productList").css({
				        	"height":product.CommodityName.length*50+"px",
				        	"padding-top":sliderHeight+"px",
				        });
				    }else if(method == "OnRspSubscribe"){
						var MoreData=JSON.parse(evt.data).Parameters.LastQuotation;
				         //更新行情的数据
				        	insertData1(MoreData);
				        	$("#refresh").removeClass("rotateClass");
				    }else if(method == "OnRtnQuote"){
				         var MoreData=JSON.parse(evt.data).Parameters;
				         //更新行情的数据
				        	insertData1(MoreData);
				    }
				};
				socket.onerror = function(evt){
				};
			};
			//订阅合约
			function sendSubscrib(jsonData){
				var commoditys = jsonData.Parameters;
		        var size = commoditys.length;
		        var setTime=null;	
		        for(var i=0;i<size;i++){
		            product.CommodityName[i]=commoditys[i].CommodityName;
		            product.CommodityNo1[i]=commoditys[i].MainContract;
		            product.CommodityNo2[i]=commoditys[i].CommodityNo;
		           	product.DotSize[i]=commoditys[i].DotSize;
		           	product.ExchangeNo[i]=commoditys[i].ExchangeNo;
		           	product.MiniTikeSize[i]=commoditys[i].MiniTikeSize;
		            product.ContractSize[i]=commoditys[i].ContractSize;
		           socket.send('{"Method":"Subscribe","Parameters":{"ExchangeNo":"'+commoditys[i].ExchangeNo+'","CommodityNo":"'+commoditys[i].CommodityNo+'","ContractNo":"'+commoditys[i].MainContract+'"}}');
		        }
			}
			function ManufacturingData(i){
				var data=[];
				return data=[product.CommodityName[i],product.CommodityNo1[i],product.CommodityNo2[i],product.ExchangeNo[i],product.DotSize[i],product.ContractSize[i],product.MiniTikeSize[i]];
			};
			//行情产品的插入
			function AddTo(){
			    var productList=document.getElementsByClassName("productList")[0];
			     productList.innerHTML="";
			    for(var i=0;i<product.CommodityName.length;i++){
       				 productList.innerHTML+="<div class='openPage'>"+
       			"<div class='productTitle'><span class='productTitleName'>"+product.CommodityNo2[i]+"</span></div>"+
       			"<div class='productContentLeft'>" +
                " <p class='productName'>"+product.CommodityName[i]+"</p> " +
                "<p class='grayFont CommodityNo'><span class='CommodityNoName'>"+product.CommodityNo2[i]+"</span>"+product.CommodityNo1[i]+"</p>" +
                " </div> " +
                "<div class='productContentRight'> " +
                "<span class='reenFont QLastPrice'>-</span> <span class='LastVolume'>-</span> <span class='ChangeRate'><p>-</p></span> </div></div>"
				};
				//生成页面传递的数据
				$(".productList").css({
		        	"height":product.CommodityName.length*50+"px",
		        	"padding-top":sliderHeight+"px",
		        });
			};
			//插入行情的方法
		 	function insertData1(MoreData) {
		        var productName = document.getElementsByClassName("productName");
		        var CommodityNo = document.getElementsByClassName("CommodityNo");
		        var LastVolume = document.getElementsByClassName("LastVolume");
		        var ChangeRate = document.getElementsByClassName("ChangeRate");
		        var LastPrice = document.getElementsByClassName("QLastPrice");
		        var productContentLeft = document.getElementsByClassName("CommodityNoName");
		        for (var i = 0; i < productContentLeft.length; i++) {          
		            if (MoreData.CommodityNo == productContentLeft[i].innerHTML) {
		                LastVolume[i].innerText = MoreData.TotalVolume;
		                if (Number(MoreData.ChangeRate) < 0) {
		                    ChangeRate[i].innerText = MoreData.ChangeRate.toFixed(2) + "%";
		                    ChangeRate[i].className = "greenBg ChangeRate";
		                }
		                else {
		                    ChangeRate[i].innerText = "+" + MoreData.ChangeRate.toFixed(2) + "%";
		                    ChangeRate[i].className = "redBg ChangeRate";
		                }
		                if (Number(MoreData.LastPrice) - Number(MoreData.PreSettlePrice) < 0) {
		                    LastPrice[i].innerText = MoreData.LastPrice.toFixed(product.DotSize[i]);
		                    LastPrice[i].className = "greenFont QLastPrice";
		                } else {
		                    LastPrice[i].innerText = MoreData.LastPrice.toFixed(product.DotSize[i]);
		                    LastPrice[i].className = "redFont QLastPrice";
		                }
		
		            }
		        };
		    }
//		 	var checkNetWorkSateInterval=setInterval(function(){
//	        	reconnectMarketSocket()
//	        },500);
	        var netWorkState=true;
	         /**
	         *提示语消失
	         * */
	        var netWorkTipsTimeout=null;
	        var checkNetWorkStateNum=0;
//	        function reconnectMarketSocket(){
//	        	var netWorkStateType=mui.checkNetworkState();
//	        	var netWorkTips=document.getElementById("netWorkTips");
//	        	if(netWorkStateType[plus.networkinfo.getCurrentType()]=="None connection"){
//	        		netWorkState=false;
//	        		if(checkNetWorkStateNum==0){
//	        			netWorkTips.style.display="block";
//	        			netWorkTipsTimeout=setTimeout(function(){
//			        	netWorkTips.style.display="none";
//			        		$(".mui-bar").css("background-color","#e9392a");
//			        	},2000);
//			        	checkNetWorkStateNum++;
//	        		}
//				}else{
//					if(netWorkState==false){
//						initmarketSocket();
//					}
//					checkNetWorkStateNum=0;
//					netWorkState=true;
//					clearTimeout(netWorkTipsTimeout);
//				}
//	        }
			/*document.getElementById("toNews").addEventListener("tap",function(){
			    document.getElementById("newsimg").setAttribute("src","images/news.png"); 
				mui.openWindow("tzdr/news/newslist.html");
			});
			document.getElementById("cp").addEventListener("tap",function(){
				mui.openWindow("tzdr/future/cp.html","cp"); 
			});*/
		});
	</script>
</html>