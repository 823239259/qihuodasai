<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
    <title></title>
    <script src="js/mui.min.js"></script>
    <script src="js/common.js"></script>
    <link href="css/mui.min.css" rel="stylesheet"/>
    <link rel="stylesheet" type="text/css" href="css/own.css"/>
    <style>
    	body{
    		background-color: #ffcc33;
    	}
    	#main_status{
    		display: none;
    	}
    </style>
    <script>  
    function showWindow(){
    	
			 	mui.openWindow({
                			url: 'guide.html',
                       		 id: 'guide.html'
                	})
			 }
    	mui.init();
    	//Android双击home键退出应用
    	var first = null;
    	//当前应用版本号
	  	var wgtVer=null;
		mui.plusReady(function(){
			plus.storage.setItem("apk","57aa92d767e58e3bfd0030c7");
			if (mui.cacheUser.isLogin()){
				mui.openWindow("tzdr/quotation/quotationMain.html","quotationMain");
			}
//			mui.getJSON("manifest.json",null,function(data){
//				alert("manifest.json1234")
//				alert("data.plus.distribute.plugins.statics.umeng"+JSON.stringify(data.plus.distribute.plugins.statics.umeng));
//			});
			//状态栏设置
			setstatus();
			 if(plus.storage.getItem("guide")==null){
				 plus.storage.setItem("guide","12");
				 setTimeout(showWindow,1);		
			 	}else{
            		var statusR =  document.getElementById("main_status");
            		statusR.style.display = "block";
            		document.getElementById("regist").addEventListener("tap",function(){
						if(mui.checkNetwork()==false){
							mui.toast("当前网络不给力，请稍后再试"); 
							return;
						}
						mui.openWindow("tzdr/login/regist.html","regist");
					});
				document.getElementById("visit").addEventListener("tap",function(){
					if(mui.checkNetwork()==false){
						mui.toast("当前网络不给力，请稍后再试"); 
						return;
					}
					mui.openWindow("tzdr/quotation/quotationMain.html","quotationMain");
				});
				document.getElementById("login").addEventListener("tap",function(){
					if(mui.checkNetwork()==false){
						mui.toast("当前网络不给力，请稍后再试"); 
						return;
					}
					mui.openWindow("tzdr/login/login.html","login");
					});
            };
			 	
			//Android双击home键退出应用
			mui.back = function(){
               if(!first) {
					first = new Date().getTime(); 
					mui.toast('再按一次退出维胜');
					setTimeout(function() {
					first = null;
					}, 1000);
				}else{
					if (new Date().getTime() - first < 1000) {   
						plus.runtime.quit();  
					} 
				}
        	};
			
			// 获取本地应用资源版本号
			plus.runtime.getProperty(plus.runtime.appid,function(inf){
				wgtVer=inf.version;
				//检查更新版本 
				checkUpdate(function(){});
			});
		});
		
		//状态栏设置
		function setstatus(){
			if(plus.navigator.isFullscreen()){
				plus.navigator.setFullscreen(false);
			}
		};
		var dataVersion;
		// 检测更新
		function checkUpdate(_callback){
			//获取最新版本信息
			mui.app_request('/getVersion',{force:true},
				function(result){
					dataVersion=result.data;
					updateApk(_callback);
//					//最新版本号
//					var newVer = result.data.version;
//					//是否强制升级
//					var isForceUpdate = false;
//					if(mui.isnull(newVer)||!(wgtVer&&newVer&&(wgtVer!=newVer))){  //没有最新版本
//						_callback();
//						if (mui.cacheUser.isLogin()){
//							mui.openWindow("tzdr/quotation/quotationMain.html");
//						}
//						return;
//					}
//					//获取数据库版本号
//					var newSub = newVer.substr(0,1);
//					//应用的版本号
//					var wgtVerSub = wgtVer.substr(0,1);
//					var newSubSmall=Number(newVer.substr(2));
//					var wgtVerSubSmall=Number(wgtVer.substr(2));
//					if(newSub > wgtVerSub){//检测升级版本是否大版本还是小版本
//						if(!tzdr.is_appstore){//当前版本是否是苹果AppStore
//							//弹出系统提示对话框
//							plus.nativeUI.alert("本次升级有较大更新，请务必重新下载安装！", function(){
//								var _download_url = tzdr.constants.api_domain+"upload/H50967E1D_.apk";
//								switch (plus.os.name ) {  //根据客户端修改充值文本框属性
//						        case "Android":
//							        //下载最新apk  
//									plus.runtime.openURL(_download_url);
//							        break;
//						        case "iOS":
//							    	//下载最新ipa
//									plus.runtime.openURL(tzdr.constants.ipa_download_url);
//									break;
//						        default:
//							        //下载最新apk  
//									plus.runtime.openURL(_download_url);
//							        break;
//						    	}
//							}, "软件升级", "立即下载" );
//						}
//						return;
//					}else{
//						if(newSub<wgtVerSub){
//							
//						}else{
//							if(newSubSmall > wgtVerSubSmall){
//							_callback();
//						//弹出版本升级提示信息对话框
//						plus.nativeUI.confirm("检测到有新版本需要升级，是否升级到最新版本?", function(e){
//							if(e.index==0){
//								downWgt(function(){
//									if (mui.cacheUser.isLogin()){
//										mui.openWindow("tzdr/quotation/quotationMain.html");
//									}
//								});	// 下载升级包
//							}else{
//								if (mui.cacheUser.isLogin()){
//									mui.openWindow("tzdr/quotation/quotationMain.html");
//								}
//							}
//						}, "软件升级", ["升级","稍后再说"] );					
//					}
//					}	
//				}	
				},function(result){
					_callback();
					if(mui.cacheUser.isLogin()){
						mui.openWindow("tzdr/quotation/quotationMain.html");
					}
					return; 
				}
    		);
	}
		function updateApk(_callback){
			dataVersion={"Android":{
				version:"2.0.2",
				bigUrl:"http://api.vs.com/upload/H50967E1D_.apk",
				littleUrl:"http://api.vs.com/upload/H50967E1D.wgt",
				isForceUpdate:false//不强制升级
				},
				"iOS":{
				version:"2.0.1",
				bigUrl:"https://itunes.apple.com/cn/app/wei-sheng-qi-huo/id1140076487?mt=8",
				isForceUpdate:true,
				}
			}
			if(plus.os.name=="Android"){
					//最新版本号
					var newVerAndroid = dataVersion.Android.version;
					//是否强制升级
					var isForceUpdate = dataVersion.Android.isForceUpdate;
					if(mui.isnull(newVerAndroid)||!(wgtVer&&newVerAndroid&&(wgtVer!=newVerAndroid))){  //没有最新版本
						_callback();
						if (mui.cacheUser.isLogin()){
							mui.openWindow("tzdr/quotation/quotationMain.html");
						}
						return;
					};
					var AndroidEditionNew = newVerAndroid.split(".");
					var AndroidEditionWgt = wgtVer.split(".");
					//获取数据库版本号
					var newSubAndroid = AndroidEditionNew[0];
					//应用的版本号
					var wgtVerSubAndroid = AndroidEditionWgt[0];
					var newSubSmallAndroid=Number(AndroidEditionNew[1]+"."+AndroidEditionNew[2]);
					var wgtVerSubSmallAndroid=Number(AndroidEditionWgt[1]+"."+AndroidEditionWgt[2]);
					if(newSubAndroid > wgtVerSubAndroid){//检测升级版本是否大版本还是小版本				
							//弹出系统提示对话框
							console.log(isForceUpdate);
							if(isForceUpdate==false){
									plus.nativeUI.confirm("检测到有新版本需要升级，是否升级到最新版本?", function(e){
										if(e.index==0){
											downWgt(function(){
												if (mui.cacheUser.isLogin()){
													mui.openWindow("tzdr/quotation/quotationMain.html");
												}
											});	// 下载升级包
										}else{
											if (mui.cacheUser.isLogin()){
												mui.openWindow("tzdr/quotation/quotationMain.html");
											}
										}
								}, "软件升级", ["升级","稍后再说"] );	
							}else{
								plus.nativeUI.alert("本次升级有较大更新，请务必重新下载安装！", function(){
								var _download_url = dataVersion.Android.bigUrl;
									plus.runtime.openURL(_download_url);
								}, "软件升级", "立即下载" );
							}
						return;
					}else{
						if(newSubAndroid<wgtVerSubAndroid){
							
						}else{
							if(newSubSmallAndroid > wgtVerSubSmallAndroid){
							_callback();
							//弹出版本升级提示信息对话框
							if(isForceUpdate==false){
									plus.nativeUI.confirm("检测到有新版本需要升级，是否升级到最新版本?", function(e){
									if(e.index==0){
										downWgt(function(){
											if (mui.cacheUser.isLogin()){
												mui.openWindow("tzdr/quotation/quotationMain.html");
											}
										});	// 下载升级包
									}else{
										if (mui.cacheUser.isLogin()){
											mui.openWindow("tzdr/quotation/quotationMain.html");
										}
									}
								}, "软件升级", ["升级","稍后再说"] );	
							}else{
								plus.nativeUI.alert("本次升级有较大更新，请务必重新下载安装！", function(){
								var _download_url = dataVersion.Android.bigUrl;
									plus.runtime.openURL(_download_url);
								}, "软件升级", "立即下载" );
							}
											
						}
					}	
				}
			}else if(plus.os.name=="iOS"){
					//最新版本号
					var newVeriOS = dataVersion.iOS.version;
					//是否强制升级
					var isForceUpdate = dataVersion.iOS.isForceUpdate;
					if(mui.isnull(newVeriOS)||!(wgtVer&&newVeriOS&&(wgtVer!=newVeriOS))){  //没有最新版本
						_callback();
						if (mui.cacheUser.isLogin()){
							mui.openWindow("tzdr/quotation/quotationMain.html");
						}
						return;
					};
					//获取数据库版本号
					var iOSEditionNew = newVeriOS.split(".");
					var iOSEditionWgt = wgtVer.split(".");
					var newSubiOS = iOSEditionNew[0];
					//应用的版本号
					var wgtVerSubiOS = iOSEditionWgt[0];
					var newSubSmalliOS=Number(iOSEditionNew[1]+"."+iOSEditionNew[2]);
					var wgtVerSubSmalliOS=Number(iOSEditionWgt[1]+"."+iOSEditionWgt[2]);
					if(newSubiOS > wgtVerSubiOS){//检测升级版本是否大版本还是小版本				
							//弹出系统提示对话框
							if(isForceUpdate==false){
								plus.nativeUI.confirm("检测到有新版本需要升级，是否升级到最新版本?", function(e){
									if(e.index==0){
										downWgt(function(){
											if (mui.cacheUser.isLogin()){
												mui.openWindow("tzdr/quotation/quotationMain.html");
											}
										});	// 下载升级包
									}else{
										if (mui.cacheUser.isLogin()){
											mui.openWindow("tzdr/quotation/quotationMain.html");
										}
									}
								}, "软件升级", ["升级","稍后再说"] );	
							}else{
								plus.nativeUI.alert("本次升级有较大更新，请务必重新下载安装！", function(){
								var _download_url = dataVersion.iOS.bigUrl;
									plus.runtime.openURL(_download_url);
								}, "软件升级", "立即下载" );
							}
							
						return;
					}else{
						if(newSubiOS<wgtVerSubiOS){
							
						}else{
							if(newSubSmalliOS > wgtVerSubSmalliOS){
							_callback();
							//弹出版本升级提示信息对话框
							if(isForceUpdate==false){
								plus.nativeUI.confirm("检测到有新版本需要升级，是否升级到最新版本?", function(e){
									if(e.index==0){
										downWgt(function(){
											if (mui.cacheUser.isLogin()){
												mui.openWindow("tzdr/quotation/quotationMain.html");
											}
										});	// 下载升级包
									}else{
										if (mui.cacheUser.isLogin()){
											mui.openWindow("tzdr/quotation/quotationMain.html");
										}
									}
								}, "软件升级", ["升级","稍后再说"] );	
							}else{
								plus.nativeUI.alert("本次升级有较大更新，请务必重新下载安装！", function(){
								var _download_url = dataVersion.iOS.bigUrl;
									plus.runtime.openURL(_download_url);
								}, "软件升级", "立即下载" );
							}
											
						}
					}	
				}
			}
		}
		// 下载wgt文件
		function downWgt(_callback,data){
			plus.nativeUI.showWaiting("下载升级包...");
//			console.log(dataVersion.Android.littleUrl);
//			var _filename = tzdr.constants.is_appstore ? 'H50967E1DAPPSTORE.wgt':'H50967E1D.wgt';//判断是不是苹果市场  、苹果市场选择第一个下载的name 
			plus.downloader.createDownload(dataVersion.Android.littleUrl, {filename:"_doc/update/"}, function(d,status){
				plus.nativeUI.closeWaiting();
				if (status == 200) { 
					installWgt(d.filename,_callback);	// 安装wgt包
				}else{
					// 弹出系统提示对话框
					plus.nativeUI.alert( "下载升级包失败！如多次失败请到官网下载最新APP。", function(){
						_callback();
					}, "软件升级", "确定" );
				}
			}).start();
		}
		
		// 更新应用资源
		function installWgt(path,_callback){
			plus.nativeUI.showWaiting("软件升级..."); 
			plus.runtime.install(path,{force:true},function(){
				plus.nativeUI.closeWaiting();
				plus.runtime.restart();
			},function(e){
				plus.nativeUI.closeWaiting();
				// 弹出系统提示对话框
				plus.nativeUI.alert( "应用升级失败！如多次失败请到官网下载最新APP。", function(){
					_callback();
				}, "软件升级", "确定" );
			});
		}
    </script>
</head>
<body>
<div class="mui-content main_page" id = "main_status">
	<img src="images/icons/LOGO.png" />
	<div class="main_link">
		<a href="javascript:void(0);" id="login" class="main_login">登录</a>
		<a href="javascript:void(0);" id="regist" class="main_regist">注册</a>
		<a href="javascript:void(0);" id="visit" class="main_other">先随便逛逛 ></a>
	</div>
	<p>Copyright © 2016 成都盈透科技有限公司 版权所有</p>
</div>
</body>
</html>
