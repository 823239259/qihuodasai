<!doctype html>
<html>

	<head>
		<meta charset="UTF-8">
		<title>行情</title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<script src="../../js/mui.min.js"></script>
		 <script src="../../js/common.js"></script>
		 <script type="text/javascript" src="../../js/common.config.js" ></script>
		<link rel="stylesheet" href="../../css/mui.min.css" />
		<link rel="stylesheet" href="../../css/own.css" />
		<link rel="stylesheet" href="../../css/quotation.css" />
	</head>
	<body>
		<header class="mui-bar mui-bar-nav">
			<a class="mui-left" id="tutorial"><img src="../../images/newUser.png"></a>
		    <h1 class="mui-title" id="quotationTitle"><span>行情交易</span></h1>
		    <a class="mui-icon mui-icon-loop mui-pull-right" id="refresh"></a>
		</header>
	<nav class="navlist">
		<a class="navon" href="javascript:void(0);" id="quotationMain">
			<span class="mui-icon"><img src="../../images/0.0.png" style="width: 20px;height:20px;"></span>
			<span class="mui-tab-label">行情交易</span>
		</a>
		<a class="" href="javascript:void(0);"  id="product">
			<span class="mui-icon"><img src="../../images/1.png" style="width: 20px;height:20px;"></span>
			<span class="mui-tab-label">操盘申请</span>
		</a>
		<a class="" href="javascript:void(0);"  id="scheme">
			<span class="mui-icon"><img src="../../images/2.png" style="width: 20px;height:20px;"></span>
			<span class="mui-tab-label">操盘记录</span>
		</a>
		<a class="" id="account" href="javascript:void(0);">
			<span class="mui-icon"><img src="../../images/3.png" style="width: 20px;height:20px;"></span>
			<span class="mui-tab-label" >账户</span>
		</a>
	</nav>
	<div class="mui-content">
		<div id="fisrtLlist"><span>合约名称</span><span>最新价</span><span>成交量</span><span>涨跌幅</span></div>
		<div class="productList">
			<div class='openPage'>
				<div class="productContentLeft" class="mui-col-xs-3">
					<p class="productName">-</p>
					<p class="grayFont CommodityNo">-</p>
				</div>
				<div class="productContentRight" class="mui-col-xs-9">
					<span class=" QLastPrice">-</span>
				 	<span class="LastVolume">-</span>
					<span><p class=" ChangeRate">-</p></span>
				</div>
			</div>
			<div class='openPage'>
				<div class="productContentLeft" class="mui-col-xs-3">
					<p class="productName ">-</p>
					<p class="grayFont CommodityNo">-</p>
				</div>
				<div class="productContentRight" class="mui-col-xs-9">
					<span class=" QLastPrice">-</span>
					<span class="LastVolume">-</span>
					<span ><p class=" ChangeRate">-</p></span>
				</div>
			</div>
			<div class='openPage'>
				<div class="productContentLeft" class="mui-col-xs-3">
					<p class="productName">-</p>
					<p class="grayFont CommodityNo">-</p>
				</div>
				<div class="productContentRight" class="mui-col-xs-9">
					<span class=" QLastPrice">-</span>
					<span class="LastVolume">-</span>
					<span ><p class=" ChangeRate">-</p></span>
				</div>
			</div>
			<div class='openPage'>
				<div class="productContentLeft" class="mui-col-xs-3">
					<p class="productName">-</p>
					<p class="grayFont CommodityNo">-</p>
				</div>
				<div class="productContentRight" class="mui-col-xs-9">
					<span class=" QLastPrice">-</span>
					<span class="LastVolume">-</span>
					<span ><p class=" ChangeRate">-</p></span>
				</div>
			</div>
			<div class='openPage'>
				<div class="productContentLeft" class="mui-col-xs-3">
					<p class="productName">-</p>
					<p class="grayFont CommodityNo">-</p>
				</div>
				<div class="productContentRight" class="mui-col-xs-9">
					<span class=" QLastPrice">-</span>
					<span class="LastVolume">-</span>
					<span ><p class=" ChangeRate">-</p></span>
				</div>
			</div>
			<div class='openPage'>
				<div class="productContentLeft" class="mui-col-xs-3">
					<p class="productName">-</p>
					<p class="grayFont CommodityNo">-</p>
				</div>
				<div class="productContentRight" class="mui-col-xs-9">
					<span class=" QLastPrice">-</span>
					<span class="LastVolume">-</span>
					<span ><p class=" ChangeRate">-</p></span>
				</div>
			</div>
			<div class='openPage'>
				<div class="productContentLeft" class="mui-col-xs-3">
					<p class="productName">-</p>
					<p class="grayFont CommodityNo">-</p>
				</div>
				<div class="productContentRight" class="mui-col-xs-9">
					<span class=" QLastPrice">-</span>
					<span class="LastVolume">-</span>
					<span ><p class=" ChangeRate">-</p></span>
				</div>
			</div>
			<div class='openPage'>
				<div class="productContentLeft" class="mui-col-xs-3">
					<p class="productName">-</p>
					<p class="grayFont CommodityNo">-</p>
				</div>
				<div class="productContentRight" class="mui-col-xs-9">
					<span class=" QLastPrice">-</span>
					<span class="LastVolume">-</span>
					<span ><p class=" ChangeRate">-</p></span>
				</div>
			</div>
			<div class='openPage'>
				<div class="productContentLeft" class="mui-col-xs-3">
					<p class="productName">-</p>
					<p class="grayFont CommodityNo">-</p>
				</div>
				<div class="productContentRight" class="mui-col-xs-9">
					<span class=" QLastPrice">-</span>
					<span class="LastVolume">-</span>
					<span ><p class=" ChangeRate">-</p></span>
				</div>
			</div>
			<div class='openPage'>
				<div class="productContentLeft" class="mui-col-xs-3">
					<p class="productName">-</p>
					<p class="grayFont CommodityNo">-</p>
				</div>
				<div class="productContentRight" class="mui-col-xs-9">
					<span class=" QLastPrice">-</span>
					<span class="LastVolume">-</span>
					<span ><p class=" ChangeRate">-</p></span>
				</div>
			</div>
		</div>
		<div class="top"></div><div class="bottom"></div>
		<div id="closeDiv"><img src="../../images/quotationColse.png" id="closeTrade"></div>
	</div>
	<script src="../../js/util.js"></script>
	<script src="../../js/jquery-1.11.3.js"></script>
		<script type="text/javascript">
		
				
		
		//初始化导航栏
			tzdr.init.initHearListener();
			mui.plusReady(function(){
				var width=plus.screen.resolutionWidth;
				/*
				 增加新手引导的样式
				 */
				if(plus.storage.getItem("QuotationGuidance")==null){
					plus.storage.setItem("QuotationGuidance","1");
					bindGuidance();
				}
				function bindGuidance(){
					var Proportion=1;
					var height=window.innerHeight;
						$(".top").css({
							"height":height+"px",
							"background-image": "url(../../images/quotation.png)",
							"display":"block",
						});
						$("#closeDiv").css({
							"display":"block",
						});
						var clickNum=0;
						$("#closeDiv").click(function(){
							$(".top").css({
								"display": "none",
							});
							$("#closeDiv").css({
								"display": "none",
							});
							$(".bottom").css({
								"display": "none",
							})
						})
						$(".bottom").click(function(){
							$("#closeDiv").css({
								"display": "none",
							});
							$(".top").css({
								"display": "none",
							});
							$(".bottom").css({
								"display": "none",
							});
						})
						$(".top").click(function(){
							if(clickNum==0){
								$(".top").css({
									"background-image": "url(../../images/quotation0.png)",
								});
								$("#closeDiv").css({
									"left":Proportion*10+"px",
								});
							}else if(clickNum==1){
								$(".top").css({
									"height":height/2-47+"px",
									"background-color":"rgba(0,0,0,0.8)",
									"background-image":"none",
								});
								$(".bottom").css({
									"display":"block",
									"bottom":"0px",
									"left":"0px",
									"height":height/2+3+"px",
									"background-image": "url(../../images/quotation4.png)",
								})
							}else{
								$(".top").css({
								"display": "none",
								});
								$("#closeDiv").css({
									"display": "none",
								});
								$(".bottom").css({
									"display":"none",
								})
							}
							clickNum++;
						})
						}
				//链接socket;
				var dataUrl={
	  				home:"../../home.html",
	  				account:"../account/account.html",
	  				accountno:"../account/accountno.html",
	  				scheme:"../scheme.html",
	  				listrg:"../future/listrg.html",
	  				quotationMain:"quotationMain.html",
	  			}
				initBottom(dataUrl);
				var url = marketSocketUrl;
					var socket = new WebSocket(url);
					function sendMessage(method,parameters){
					    socket.send('{"Method":"'+method+'","Parameters":'+parameters+'}');
					}
					socket.onopen = function(evt){
					    var user = marketUserName;
					    var pwd = marketPassword;
					    socket.send('{"Method":"Login","Parameters":{"UserName":"' + user +'","PassWord":"' + pwd +'"}}');
					};
					//设置变量
					var CommodityName=[];
					var CommodityNo1=[];
					var CommodityNo2=[];
					var DotSize=[];
					var ExchangeNo=[];
					var MiniTikeSize=[];
					var ContractSize = [];
					var product={
					    CommodityName:CommodityName,
					    CommodityNo1:CommodityNo1,
					    CommodityNo2:CommodityNo2,
					    DotSize:DotSize,
					    ExchangeNo:ExchangeNo,
					    MiniTikeSize:MiniTikeSize,
					    ContractSize:ContractSize
					}
					socket.onclose = function(evt){

					};
					socket.onmessage = function(evt){ 
					    var data = evt.data;
					    var jsonData = JSON.parse(data);
					    var method = jsonData.Method;
					    if(method=="OnRspLogin"){
					    	  sendMessage('QryCommodity',null)
					    }else if(method == "OnRspQryCommodity"){
					        var commoditys = jsonData.Parameters;
					        var size = commoditys.length;
					        var setTime=null;			          
					        for(var i=0;i<size;i++){
					            product.CommodityName[i]=commoditys[i].CommodityName;
					            product.CommodityNo1[i]=commoditys[i].MainContract;
					            product.CommodityNo2[i]=commoditys[i].CommodityNo;
					           	product.DotSize[i]=commoditys[i].DotSize;
					           	product.ExchangeNo[i]=commoditys[i].ExchangeNo;
					           	product.MiniTikeSize[i]=commoditys[i].MiniTikeSize;
					            product.ContractSize[i]=commoditys[i].ContractSize;
					           socket.send('{"Method":"Subscribe","Parameters":{"ExchangeNo":"'+commoditys[i].ExchangeNo+'","CommodityNo":"'+commoditys[i].CommodityNo+'","ContractNo":"'+commoditys[i].MainContract+'"}}');
					        }
					        //插入主力合约
					        AddTo()
					    }else if(method == "OnRspSubscribe"){
							var MoreData=JSON.parse(evt.data).Parameters.LastQuotation;
					         //更新行情的数据
//					         	console.log(JSON.stringify(MoreData));
					        	insertData1(MoreData);
					        
					    }else if(method == "OnRtnQuote"){
					         var MoreData=JSON.parse(evt.data).Parameters;
					         //更新行情的数据
					        	insertData1(MoreData);
					    }
					};
					socket.onerror = function(evt){
					};
					function ManufacturingData(i){
    					var data=[];
    					return data=[product.CommodityName[i],product.CommodityNo1[i],product.CommodityNo2[i],product.ExchangeNo[i],product.DotSize[i],product.ContractSize[i],product.MiniTikeSize[i]];
	    				};
					//行情产品的插入
				function AddTo(){
				    var productList=document.getElementsByClassName("productList")[0];
				     productList.innerHTML="";
				    for(var i=0;i<product.CommodityName.length;i++){
           				 productList.innerHTML+="<div class='openPage'><div class='productContentLeft mui-col-xs-3' >" +
                    " <p class='productName'>"+product.CommodityName[i]+"</p> " +
                    "<p class='grayFont CommodityNo'><span class='CommodityNoName'>"+product.CommodityNo2[i]+"</span>"+product.CommodityNo1[i]+"</p>" +
                    " </div> " +
                    "<div class='productContentRight' class='mui-col-xs-9'> " +
                    "<span class='reenFont QLastPrice'>-</span> <span class='LastVolume'>-</span> <span class='ChangeRate'><p>-</p></span> </div></div>"
						
						
    				};
    				//生成页面传递的数据
//  				$(".productList").css("height",48*product.CommodityName.length+"px");
    				
			    	$(".openPage").click(function(){
			    		$(".top,.bottom").css({
			    				"display":"none",
			    		});
			            var _this = $(this);
			            _this.css("background-color","#1f1f1f")
			            var index=_this.index();
			            var data=ManufacturingData(index);
			            sendMessage('Logout','{"UserName":"'+marketUserName+'"}');
			            socket.close();
			            mui.openWindow({
							url:"transactionDetails.html",
							id:"transactionDetails",
							 extras:{
								name:data,
							}
						});
			      });
				};
				//插入行情的方法
			 function insertData1(MoreData) {
			        var productName = document.getElementsByClassName("productName");
			        var CommodityNo = document.getElementsByClassName("CommodityNo");
			        var LastVolume = document.getElementsByClassName("LastVolume");
			        var ChangeRate = document.getElementsByClassName("ChangeRate");
			        var LastPrice = document.getElementsByClassName("QLastPrice");
			        var productContentLeft = document.getElementsByClassName("CommodityNoName");
			        for (var i = 0; i < productContentLeft.length; i++) {          
			            if (MoreData.CommodityNo == productContentLeft[i].innerHTML) {
			                LastVolume[i].innerText = MoreData.TotalVolume;
			                if (Number(MoreData.ChangeRate) < 0) {
			                    ChangeRate[i].innerText = MoreData.ChangeRate.toFixed(2) + "%";
			                    ChangeRate[i].className = "greenBg ChangeRate";
			                }
			                else {
			                    ChangeRate[i].innerText = "+" + MoreData.ChangeRate.toFixed(2) + "%";
			                    ChangeRate[i].className = "redBg ChangeRate";
			                }
			                if (Number(MoreData.LastPrice) - Number(MoreData.PreSettlePrice) < 0) {
			                    LastPrice[i].innerText = MoreData.LastPrice.toFixed(product.DotSize[i]);
			                    LastPrice[i].className = "greenFont QLastPrice";
			                } else {
			                    LastPrice[i].innerText = MoreData.LastPrice.toFixed(product.DotSize[i]);
			                    LastPrice[i].className = "redFont QLastPrice";
			                }
			
			            }
			        };
			    }
			document.getElementById("product").addEventListener("tap",function(){
				sendMessage('Logout','{"UserName":"'+marketUserName+'"}');
				socket.close();
			});
			document.getElementById("scheme").addEventListener("tap",function(){
				sendMessage('Logout','{"UserName":"'+marketUserName+'"}');
					socket.close();
			});
			document.getElementById("account").addEventListener("tap",function(){
				sendMessage('Logout','{"UserName":"'+marketUserName+'"}');
					socket.close();
			});
			document.getElementById("refresh").addEventListener("tap",function(){
				var re = plus.webview.getWebviewById("quotationMain");
					if(re != null || re != undefined){
						re.reload(); 
					}
			});
			function referPage(){
				plus.webview.getWebviewById("quotationMain").reload();
			}
			document.getElementById("tutorial").addEventListener("tap",function(){
				mui.openWindow({
					url:"tutorial.html",
					id:"tutorial",
				});
			})
			setstatus();
			function setstatus(){
				if(plus.navigator.isFullscreen()){
					plus.navigator.setFullscreen(false);
				}
			};
			var first=null;
			//Android双击home键退出应用
				mui.back = function(){
	               if(!first) {
						first = new Date().getTime(); 
						mui.toast('再按一次退出维胜');
						setTimeout(function() {
						first = null;
						}, 1000);
						}else{
							if (new Date().getTime() - first < 1000) {   
								plus.runtime.quit();  
							} 
						}
		        	};
			});
			
		</script>
	</body>
</html>
