<!doctype html>
<html>
	<head>
		<meta charset="UTF-8">
		<title></title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<script src="../../js/mui.min.js"></script>
		 <script src="../../js/common.js"></script>
		 <script type="text/javascript" src="../../js/common.config.js" ></script>
		 <script type="text/javascript" src="../../js/jquery-1.11.3.js" ></script>
		 <script type="text/javascript" src="../../js/jquery.base64.js" ></script>
		 <script type="text/javascript" src="../../js/trade.send.js" ></script>
		 <script type="text/javascript" src="../../js/util.js" ></script>
		<link rel="stylesheet" href="../../css/mui.min.css" />
		<link rel="stylesheet" href="../../css/quotation.css" />
	</head>

	<body>
		<header class="mui-bar mui-bar-nav own-topbg">
		<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left quotationBack" id = "backClose" ></a>
		<h1 class="mui-title">操盘登录</h1>
		<a id='forgetPassword' href="javascript:void(0)">忘记密码</a>
		<!--<a href="javascript:void(0)" class="top-tel" id="telBtn">客服热线</a>-->
	</header>
	<div class="mui-content operateLogin">
		<form  class="mui-input-group blackBg">
			<div class="mui-input-row">
				<label>选择操盘账号</label>
				<select class="accountSelect mui-btn mui-btn-block">
					<option class="mui-selected" id="checkContent" value="test1">请选择操盘账号</option>
				</select>
			</div>
			<div class="mui-input-row" id="userAcount">
				<label>操盘账号</label>
				<input id='account' type="text" class="mui-input-clear mui-input" placeholder="请输入您的操盘账号" >
			</div>
			<div class="mui-input-row mui-password">
				<label>登录密码</label>
				<input id="password" type="password" class="mui-input-password" placeholder="请输入您的账号密码" autocomplete="off" onkeyup="value=value.replace(/[\W]/g,'')" onbeforepaste="clipboardData.setData('text',clipboardData.getData('text').replace(/[^\d]/g,''))">
			</div>	
		</form>
		<div class="mui-content-padded">
			<button  class="mui-btn mui-btn-block" id="operateLogin">登录交易</button>
			<button id='regLogin' class="mui-btn mui-btn-block">开通外盘期货账户</button>
			<!--<div class="link-area"><!--<a  href="javascript:void(0)">开通外盘期货账户</a>
			</div>-->
		</div>
		<!--<div class="mui-content-padded">
			<p class="RegistrationTips"><input name="checkbox" value="Item 1" type="checkbox" checked id="loginCheckbox">阅读并接受<a href="javascript:void(0);" id="tzdr_info" style="color: #FFCC33;">《维胜行情交易协议》</a></p>
		</div>-->
		<div class="mui-input-row mui-checkbox mui-left mui-content-padded" id="loginIform">
				
				<p id="loginAgree"><input name="checkbox" type="checkbox"  id="checkBox"  value="1" checked="checked" style="width: 28px !important; margin-top: 2px;">阅读并接受<a href="javascript:void(0);" id="tzdr_info" style="color: #FFCC33;">《维胜行情交易协议》</a></p>
		
		</div>
	</div>
		<script type="text/javascript">
			mui.init();
			mui.plusReady(function(){
				var islogin = false;
				var num=0
				$("#checkBox").click(function(){
					if(num==0){
						$("#checkBox").val(2);
						num=1
					}else{
						$("#checkBox").val(1);
						num=0;
					}
				});
				/*
				 * 选择账号
				 */
				var user_mobile=mui.cacheUser.get(tzdr.constants.user_mobile);
				var user=[];
				if(user_mobile==null){
					$("#checkContent").text("其它");
				}else{
					mui.app_request("/operateLogin",{mobile:user_mobile},function(result){
					var data=result.data;
					var Len=data.length;
					for(var i=0;i<=Len;i++){
						if(i==Len){
							$(".accountSelect").append("<option value='test'>其它</option>");
						}else{
							$(".accountSelect").append("<option value="+data[i].tranAccount+">"+data[i].tranAccount+"</option>");
							var acount={};
							acount.tranAccount=data[i].tranAccount;
							acount.tranPassword=data[i].tranPassword;
							user[i]=acount;
						}
					};
					
				},function(result){
//					console.log(JSON.stringify(result));
				});
				}
				
				if(user_mobile==null || user_mobile==undefined || user_mobile==""){
					
				}else{
					$("#account").attr("disabled","disabled");
//					$("#password").attr("readonly","readonly");
					$("#userAcount").css("display","none");
				}
				$(".accountSelect").change(function(){
					var val=$(".accountSelect").val();
					if(val=="test"){
						$("#account").removeAttr("disabled");
						$("#account").val("");
						$("#password").val("");
						$("#userAcount").css("display","block");
					}else if(val=="test1"){
						$("#password").val("");
						$("#userAcount").css("display","none");
					}else{
						for(var i=0;i<user.length;i++){
							if(val==user[i].tranAccount){
								$("#account").val(val);
							;
								$("#password").val(user[i].tranPassword);
							}
						}
						$("#account").attr("disabled","disabled").css("display","none");
//						$("#password").attr("readonly","readonly");
						$("#userAcount").css("display","none");
					}
				})
				var accountEnd = endLoginAccount == null?"":endLoginAccount;
				if(accountEnd != ""){
					$("#userAcount").show();
				}
				$("#account").val(accountEnd);
				$("#password").val(endLoginPassword == null ? "" : $.base64.decode(endLoginPassword));
				/**
				 * 登录超时处理 
				 */
				var loginSetTimeOut = null;
				function setTimeOutIsLogin(){
					loginSetTimeOut = setTimeout(function(){
						if(!islogin){
							plus.nativeUI.closeWaiting();
							mui.toast("网络不给力");
						}
					},10000);
				}
				var Transfer=plus.webview.currentWebview();
				var commdityNo = Transfer.commdityNo;
				var account = null;
				var pwd = null;
				document.getElementById("regLogin").addEventListener("tap",function(){
//					var url = "";
//					var urlId = "";
//					switch(commdityNo){
//						//A50
//						case  "CN":
//								url = "../future/cn.html";
//								urlId = "cn";
//							break;
//						//恒指
//						case  "HSI":
//								url = "../future/hsi.html";
//								urlId = "hsi";
//							break;
//						//原油
//						case  "CL":
//								url = "../future/cl.html";
//								urlId = "cl";
//							break;
//						default:
//								url = "../future/cp.html";
//								urlId = "cp";
//							break;
//					}
					mui.openWindow({
									url:"../future/cp.html",
									id:"cp"
								});
				});
				document.getElementById("forgetPassword").addEventListener("tap",function(){
					mui.callService();
				});
				document.getElementById("backClose").addEventListener("tap",function(){
					if (Transfer.backpageID){
						backReload();
					}else{
						mui.back();
					}
					
				});
				$("#operateLogin").click(function(){
					if(username == null){
						account=document.getElementById("account").value;
						pwd=$.base64.encode(document.getElementById("password").value);
						if(mui.isnull(account)){
			    			mui.toast("请输入账号");
			    			return;
							};
			
						if(mui.isnull(pwd)){
			    			mui.toast("请输入密码");
			    			return;
						}
						if($("#checkBox").val()==1){
						        
						}else{
						     mui.toast("您还未勾选协议"); 
						   return;
						  };
						plus.nativeUI.showWaiting( "正在登录中" );
						setTimeOutIsLogin();
						var loginSocket = new WebSocket(TradeUrl.SocketUrl);
						loginSocket.onopen = function(){
							loginSocket.send('{"Method":"'+TradeUrl.LoginUrl+'","Parameters":{"ClientNo":"'+account+'","PassWord":"'+pwd+'"}}');
						}
						loginSocket.onmessage = function(evt){
							var dataString = evt.data;
							var data = JSON.parse(dataString);
							var method = data.Method;
							var parameters = data.Parameters;
							if (method == "OnRspLogin") {
								var code = parameters.Code;
								var loginMessage = parameters.Message;
								if (code == 0) {
										localStorage.setItem("account",account);
										localStorage.setItem("password",pwd);
										localStorage.setItem("endLoginAccount",account);
										localStorage.setItem("endLoginPassword",pwd);
									if (Transfer.backpageID){
										backReload();
										plus.nativeUI.closeWaiting();
										mui.toast("登录成功");
										islogin = true;
				      					mui.app_back(Transfer.backpageID,true);   //放回businessPageId页面，并且刷新该页面信息
				      					return;
		      						}else{
		      							plus.nativeUI.closeWaiting();
										mui.toast("登录成功");
										islogin = true;
		      							mui.openWindow({
		      								url:"../quotation/quotationMain.html",
		      								id:"quotationMain"
		      							})
		      						}
								} else {
									alertProtype(loginMessage,"提示",Btn.confirmed());
									plus.nativeUI.closeWaiting();
								}
							} 
						}
						loginSocket.onclose = function(){
							if(loginSetTimeOut != null){ 
								clearTimeout(loginSetTimeOut);
							}
							plus.webview.getWebviewById("operateLogin").reload();
						}
					}else{
						alertProtype("你已登录,请勿重复登录","提示",Btn.confirmed());
					}
				});
				function backReload(){
					plus.webview.getWebviewById("transactionDetails").reload();
				};
				document.getElementById("tzdr_info").addEventListener("tap",function(){
					mui.openWindow({
						url:"../agree/tradingMarket.html",
						id:"tradingMarket"
					})
				});
//				$("#account")
			});
			
		</script>
	</body>

</html>
