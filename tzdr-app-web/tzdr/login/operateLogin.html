<!doctype html>
<html>
	<head>
		<meta charset="UTF-8">
		<title></title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<script src="../../js/mui.min.js"></script>
		 <script src="../../js/common.js"></script>
		 <script type="text/javascript" src="../../js/common.config.js" ></script>
		 <script type="text/javascript" src="../../js/jquery-1.11.3.js" ></script>
		 <script type="text/javascript" src="../../js/jquery.base64.js" ></script>
		<script type="text/javascript" src="../../js/trade.config.js" ></script>
		<script type="text/javascript" src="../../js/util.js" ></script>
		 <script type="text/javascript" src="../../js/trade.connection.js" ></script>
		 <script type="text/javascript" src="../../js/trade.send.js" ></script>
		<link rel="stylesheet" href="../../css/mui.min.css" />
		<link rel="stylesheet" href="../../css/quotation.css" />
	</head>
	<body>
		<header class="mui-bar mui-bar-nav own-topbg">
		<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left quotationBack" id = "backClose" ></a>
		<h1 class="mui-title">操盘登录</h1>
		<a id='forgetPassword' href="javascript:void(0)">忘记密码</a>
	</header>
	<div class="mui-content" class="operateLogin">
		<div id="inputList">
			<div id="accountType" class="commStyle">
				<label>账号类型：</label>
				<select class="accountSelect mui-btn mui-btn-block">
					<option class="mui-selected" id="checkContent" value="1">模拟账号</option>
					<option class="mui-selected"  value="0">实盘账号</option>
				</select>
				<img src="../../images/down.png">
			</div>
			<div class="commStyle">
				<label>登录账号：</label>
				<input type="text"  placeholder="请输入您的账号" id='account' oninput="checkValue()"/>
				<img src="../../images/close.png" id="accountClear">
			</div>
			<div class="commStyle">
				<label>登录密码：</label>
				<input type="password"  placeholder="请输入您的密码" id="password" oninput="checkValue()"/>
				<img src="../../images/close.png" id="passwordClear">
			</div>
			<div class="mui-content-padded" style="margin-top: 20px;">
				<button  class="mui-btn mui-btn-block" id="operateLogin">登录交易</button>
				<button id='regLogin' class="mui-btn mui-btn-block">开通外盘期货账户</button>
			</div>
			<div class="mui-input-row mui-checkbox mui-left mui-content-padded" id="loginIform">
				<p id="loginAgree"><span id="checkBox"><i ></i></span><sapn>阅读并接受</sapn><a href="javascript:void(0);" id="tzdr_info" style="color: #FFCC33;">《维胜行情交易协议》</a></p>
			</div>
		</div>
		<div class="top"></div><div class="bottom"></div>
		<div id="closeDiv"><img src="../../images/quotationColse.png" id="closeTrade"></div>
		<div id="username_list">
			<ul>
				<li></li>
				<li></li>
				<li></li>
				<li></li>
			</ul>
		</div>
	</div>
		<script type="text/javascript">
		    initTradeConfig();
			mui.init();
				var width=window.innerWidth;
					$(".commStyle input,.commStyle select").css({
						"width":width-115+"px"
					});
			mui.plusReady(function(){
				/*加载新手指南*/
				if(plus.storage.getItem("QuotationGuidanceLogin")==null){
					plus.storage.setItem("QuotationGuidanceLogin","1");
					bindGuidance();
				}
				function bindGuidance(){
					var height=window.innerHeight;
						$(".top").css({
							"height":height+"px",
							"background-image": "url(../../images/quotationLogin.png)",
							"display":"block",
						});
						$("#closeDiv").css({
							"display":"block"
						});
						$("#closeDiv").click(function(){
							$(".top,#closeDiv,.bottom").css({
								"display": "none",
							});
						});
						var clickNum=0;
						$(".top").click(function(){
							if(clickNum==0){
								$(".top").css({
									"height":263+"px",
									"background-color":"rgba(0,0,0,0.8)",
									"background-image":"none",
									"top":"0px"
								});
								$(".bottom").css({
									"display":"block",
									"bottom":"0px",
									"left":"0px",
									"height":height-263-40+"px",
									"background-image": "url(../../images/quotationLogin1.png)",
								})
							}else{
								$(".top,#closeDiv,.bottom").css({
									"display": "none",
								});
							};
							clickNum++;
						});
						$(".bottom").click(function(){
								$(".top,#closeDiv,.bottom").css({
									"display": "none",
								});
						})
				};
				var islogin = false;
				var num=0
				$("#checkBox i").val(1);
				$("#checkBox").click(function(){
					if(num==0){
						$("#checkBox i").val(2);
						$("#checkBox i").css({
							"background-color":"rgba(0, 0, 0, 0)" ,
						})
						num=1
					}else{
						$("#checkBox i").val(1);
						num=0;
						$("#checkBox i").css({
							"background-color":"#fcc900" ,
						})
					}
				});
				/*绑定事件
				 */
				$("#accountClear").click(function(){
					$("#account").val("");
					checkValue()
				});
				$("#passwordClear").click(function(){
					$("#password").val("");
					checkValue()
				})
				/*
				 * 选择账号
				 */
				var user_mobile=mui.cacheUser.get(tzdr.constants.user_mobile);
				var user=[];
				if(user_mobile==null){
				}else{
					var paramUrl={
						url:"login.html"
					}
					mui.app_request("/operateLogin",{mobile:user_mobile},function(result){
					var data=result.data;
					var Len=data.length;
					for(var i=0;i<=Len;i++){
						if(i==Len){
						}else{
							var acount={};
							acount.tranAccount=data[i].tranAccount;
							acount.tranPassword=data[i].tranPassword;
							user[i]=acount;
						}
					};
					
				},function(result){
				},paramUrl);
				}
				
				if(user_mobile==null || user_mobile==undefined || user_mobile==""){
					
				}else{
				}
				$(".accountSelect").change(function(){
					var val=$(".accountSelect").val();
					if(val=="test-vs"){
					}else if(val=="test1-vs"){
					}else{
						for(var i=0;i<user.length;i++){
							if(val==user[i].tranAccount){
							}
						}
						$("#userAcount").css("display","none");
					}
				})
				var accountEnd = endLoginAccount == null?"":endLoginAccount;
				if(accountEnd != ""){
					$("#userAcount").show();
				}   
				$("#account").val(accountEnd);
				if($("#account").val()!="" || $("#account").val()!=null){
					$("#operateLogin").css({
						"background-color":"#fcc900"
					});
				}
				$("#password").val(endLoginPassword == null ? "" : $.base64.decode(endLoginPassword));
				if(tradeWebSocketIsMock != undefined && tradeWebSocketIsMock != null){
					$(".accountSelect").val(tradeWebSocketIsMock);
				}else{ 
					$(".accountSelect").val(0);
					tradeWebSocketIsMock = 0; 
				}    
				getVersion();   
				setTradeConfig(tradeWebSocketIsMock); 
				$(".accountSelect").change(function(){
					var $this = $(this);
					var val = $this.val(); 
					setTradeConfig(val);
				}); 
				  
				/**
				 * 登录超时处理 
				 */
				var loginSetTimeOut = null;
				function setTimeOutIsLogin(){
					loginSetTimeOut = setTimeout(function(){
						if(!islogin){
							plus.nativeUI.closeWaiting();
							mui.toast("网络不给力");
						}
					},10000);
				}
				var Transfer=plus.webview.currentWebview();
				var commdityNo = Transfer.commdityNo;
				var account = null;
				var pwd = null;
				document.getElementById("regLogin").addEventListener("tap",function(){
					$(".top,.bottom").css({
			    			"display":"none",
			    		});
					mui.openWindow({
									url:"../future/cp.html",
									id:"cp"
								});
				});
				document.getElementById("forgetPassword").addEventListener("tap",function(){
					mui.callService();
				});
				document.getElementById("backClose").addEventListener("tap",function(){
					if (Transfer.backpageID){
						backReload();
					}else{
						mui.back();
					}
					
				});
				$("#operateLogin").click(function(){
					if(username == null){
						account=document.getElementById("account").value;
						pwd=$.base64.encode(document.getElementById("password").value);
						if(mui.isnull(account)){
			    			mui.toast("请输入账号");
			    			return; 
							};
			
						if(mui.isnull(pwd)){
			    			mui.toast("请输入密码");
			    			return;
						}
						if($("#checkBox i").val()==1){
						        
						}else{
						     mui.toast("您还未勾选协议"); 
						   return;
						  };
						plus.nativeUI.showWaiting( "正在登录中" );
						setTimeOutIsLogin();
						var loginSocket = new WebSocket(socketUrl);
						loginSocket.onopen = function(){
							loginSocket.send('{"Method":"'+TradeUrl.LoginUrl+'","Parameters":{"ClientNo":"'+account+'","PassWord":"'+pwd+'","IsMock":'+tradeWebSocketIsMock+',"Version":"'+tradeWebSocketVersion+'"}}');
						}
						loginSocket.onmessage = function(evt){
							var dataString = evt.data;
							var data = JSON.parse(dataString);
							var method = data.Method;
							var parameters = data.Parameters;
							if (method == "OnRspLogin") {
								var code = parameters.Code;
								var loginMessage = parameters.Message;
								if (code == 0) {
										localStorage.setItem("trade_account",account);
										localStorage.setItem("trade_password",pwd); 
										localStorage.setItem("trade_endLoginAccount",account);
				 						localStorage.setItem("trade_endLoginPassword",pwd);
									if (Transfer.backpageID){
										backReload();
										plus.nativeUI.closeWaiting();
										mui.toast("登录成功");
										localStorage.setItem("isMock",tradeWebSocketIsMock);
										islogin = true;
				      					mui.app_back(Transfer.backpageID,true);   //放回businessPageId页面，并且刷新该页面信息
				      					return;
		      						}else{
		      							plus.nativeUI.closeWaiting(); 
										mui.toast("登录成功");
										localStorage.setItem("isMock",tradeWebSocketIsMock);
										islogin = true;
		      							mui.openWindow({
		      								url:"../quotation/quotationMain.html",
		      								id:"quotationMain"
		      							})
		      						}
								} else {
									alertProtype(loginMessage,"提示",Btn.confirmed());
									plus.nativeUI.closeWaiting();
								}
							} 
						}
						loginSocket.onclose = function(){
							if(loginSetTimeOut != null){ 
								clearTimeout(loginSetTimeOut);
							}
							plus.webview.getWebviewById("operateLogin").reload();
						}
					}else{
						alertProtype("你已登录,请勿重复登录","提示",Btn.confirmed());
					}
				});
				function backReload(){
					plus.webview.getWebviewById("transactionDetails").reload();
				};
				document.getElementById("tzdr_info").addEventListener("tap",function(){
					mui.openWindow({
						url:"../agree/tradingMarket.html",
						id:"tradingMarket"
					})
				});
			});
			/*按钮变色*/
			function checkValue(){
				var account=$("#account").val();
				var password=$("#password").val();
				if(password.length>0 && password.length>0){
					$("#operateLogin").css({
						"background-color":"#fcc900"
					});
				}else{
					$("#operateLogin").css({
						"background-color":"#cccccc"
					});
				}
			}
		</script>
	</body>

</html>
