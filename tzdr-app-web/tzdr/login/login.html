<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
    <title>用户登录</title>    
    <link rel="stylesheet" href="../../css/mui.min.css" />
    <link rel="stylesheet" href="../../css/own.css" />
    <script type="text/javascript" src="../../js/mui.min.js"></script>  
    <script type="text/javascript" src="../../js/common.js"></script>
    <style>
	.area {
		margin: 20px auto 0px auto;
	}
	.mui-input-group {
		margin-top: 10px;
	}
	.mui-input-group:first-child {
		margin-top: 25px;
	}
	.mui-input-group label {
		width: 22%;
	}
	.mui-input-row label~input,
	.mui-input-row label~select,
	.mui-input-row label~textarea {
		width: 65%; height: 45px;
	}
	.mui-checkbox input[type=checkbox],
	.mui-radio input[type=radio] {
		top: 6px;
	}
	.mui-content-padded {
		margin-top: 25px;
	}
	.mui-btn {
		padding: 10px;
	}
	.link-area {
		display: block;
		margin-top: 25px;
		text-align: center;
	}
	.spliter {
		color: #bbb;
		padding: 0px 8px;
	}
	.oauth-area {
		position: absolute;
		bottom: 20px;
		left: 0px;
		text-align: center;
		width: 100%;
		padding: 0px;
		margin: 0px;
	}
	.oauth-area .oauth-btn {
		display: inline-block;
		width: 50px;
		height: 50px;
		background-size: 30px 30px;
		background-position: center center;
		background-repeat: no-repeat;
		margin: 0px 20px;
		/*-webkit-filter: grayscale(100%); */
		
		border: solid 1px #ddd;
		border-radius: 25px;
	}
	.oauth-area .oauth-btn:active {
		border: solid 1px #aaa;
	}
	</style>
	<script>
	var win= null;
		mui.init();
		mui.plusReady(function(){
			if (mui.cacheUser.isLogin()){
				mui.openWindow("../quotation/quotationMain.html");
			}
			win=plus.webview.currentWebview();
			 
			// 清除缓存页面
			//mui.cacheUser.clearCachePages();
			
			//清除遗留数据
			clearinfo();
			document.getElementById("back").addEventListener("tap",function(){
    			history.back();
    		});
    		document.getElementById("telBtn").addEventListener("tap",function(){
    			mui.callService();
    		});
			document.getElementById("reg").addEventListener("tap",function(){
				mui.openWindow("regist.html");
			});
			document.getElementById("forgetPassword").addEventListener("tap",function(){
				mui.openWindow("password.html");
			});
			document.getElementById("login").addEventListener("tap",function(){
				userLogin();
			});
		});
		function clearinfo(){
			document.getElementById("account").value="";
			document.getElementById("password").value="";
		};
//		function MacthValue(){
//			var mobile=document.getElementById("account").value;
//			var mobilePattern={mobile: /^0?(13[0-9]|15[012356789]|18[0236789]|14[57])[0-9]{8}$/ };
//			
//		}
		function userLogin(){
			var mobile=document.getElementById("account").value;
			var password=document.getElementById("password").value;
			//这里要对手机号码进行格式校验
    		if(!tzdr.validate_mobile(mobile)||mui.isnull(mobile)){
    			mui.toast("手机号码不正确");
    			return;
    		}
    		if(mui.isnull(password)){
    			mui.toast("帐号或密码错误！");
    			return;
    		}
			var paramUrl={
				url:"login.html"
			}
			mui.app_request('/login',{ 
      			 'loginName':mobile,
			    'password':password
      	},function(result){
      				mui.toast("登录成功！"); 
      				//存储用户信息
      				mui.cacheUser.save(result.data.token,result.data.secret,mobile);
      				if (win.backpageID){ 
      					mui.app_back(win.backpageID,true);   //放回businessPageId页面，并且刷新该页面信息
      					return;
      				}
      				var wsreload = plus.webview.getWebviewById("quotationMain");
      				if(wsreload != null){
	      				wsreload.reload(); 
      				}
      				mui.openWindow("../quotation/quotationMain.html","quotationMain");
      				return;
      			
      	},function(result){
      			if(result.code==3){
      				mui.toast("用户名或密码为空！"); 
      				return;
      			}else if(result.code==4){
      				mui.toast("帐号或密码错误！"); 
      				return;
      			}else if(result.code==2){
      				mui.toast("登录失败！"); 
      				return;
      			}else{
      				mui.toast("帐号或密码错误");
      				return;
      			}
      			
      		},paramUrl);
			
		};
		
	</script>
</head>
<body class="ui-page-login">	
	<header class="mui-bar mui-bar-nav own-topbg">
		<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left" id="back"></a>
		<h1 class="mui-title">用户登录</h1>		
		<a href="javascript:void(0)" class="top-tel" id="telBtn">客服热线</a>
	</header>
	<div class="mui-content">
		<form id='login-form' class="mui-input-group">
			<div class="mui-input-row">
				<label>手机号码</label>
				<input id='account' type="tel" class="mui-input-clear mui-input" placeholder="请输入账号" autocomplete="off"  onkeyup="this.value=this.value.replace(/\D/g,'')" onafterpaste="this.value=this.value.replace(/\D/g,'')">
			</div>
			<div class="mui-input-row mui-password">
				<label>登录密码</label>
				<input id="password" type="password" class="mui-input-password" placeholder="请输入密码" autocomplete="off" onkeyup="value=value.replace(/[\W]/g,'')" onbeforepaste="clipboardData.setData('text',clipboardData.getData('text').replace(/[^\d]/g,''))" >
			</div>	
		</form>
		<div class="mui-content-padded">
			<button id='login' class="mui-btn mui-btn-block lg-btnlogin">立即登录</button>
			<div class="link-area"><a id='reg' href="javascript:void(0)">注册账号</a><a id='forgetPassword' href="javascript:void(0)">忘记密码</a>
			</div>
		</div>
		<div class="mui-content-padded oauth-area">
		</div>
	</div>
</body>
</html>